---
title: percentiles_arrayif
description: 'This page explains how to use the percentiles_array function in APL.'
---

Use `percentiles_arrayif` to calculate approximate percentile values for a numeric expression when a certain condition evaluates to true. This function is useful when you want an array of percentiles instead of a single percentile. You can use it to understand data distributions in scenarios such as request durations, event processing times, or security alert severities, while filtering on specific criteria.

## For users of other query languages

If you come from other query languages, this section explains how to adjust your existing queries to achieve the same results in APL.

<AccordionGroup>
<Accordion title="Splunk SPL users">

In Splunk SPL, you often use statistical functions such as `perc<percent>` or `percN()` to compute percentile estimates. In APL, you use `percentiles_arrayif` and provide a predicate to define which records to include in the computation.

<CodeGroup>
```sql Splunk example
index=main sourcetype=access_combined
| stats perc90(req_duration_ms) AS p90, perc99(req_duration_ms) AS p99
```

```kusto APL equivalent
['sample-http-logs']
| summarize Dist=percentiles_arrayif(req_duration_ms, 90, 99, status == '200')
```
</CodeGroup>

</Accordion>
<Accordion title="ANSI SQL users">

In ANSI SQL, you often use window functions like `PERCENTILE_DISC` or `PERCENTILE_CONT` or write multiple `CASE` expressions for conditional aggregation. In APL, you can achieve similar functionality with `percentiles_arrayif` by passing the numeric field and condition to the function.

<CodeGroup>
```sql SQL example
SELECT
  PERCENTILE_DISC(0.90) WITHIN GROUP (ORDER BY req_duration_ms) AS p90,
  PERCENTILE_DISC(0.99) WITHIN GROUP (ORDER BY req_duration_ms) AS p99
FROM sample_http_logs
WHERE status = '200';
```

```kusto APL equivalent
['sample-http-logs']
| where status == '200'
| summarize Dist=percentiles_arrayif(req_duration_ms, 90, 99, true)
```
</CodeGroup>

</Accordion>
</AccordionGroup>

# Usage

## Syntax

```kusto
percentiles_arrayif(Expression, Percentile1, Percentile2, ..., Predicate)
```

## Parameters

| Parameter    | Description                                                               |
|------------- |---------------------------------------------------------------------------|
| Expression   | A numeric expression for which you want to compute percentile values.     |
| Percentile1, Percentile2, ... | One or more percentile values (between 0 and 100).       |
| Predicate    | A Boolean expression that indicates which records to include in the calculation. |

## Returns

The function returns an array of approximate percentile values, corresponding to the numeric expression for the records that satisfy `Predicate`. The position of each returned percentile in the array matches the order in which it appears in the function call.

## Use case examples

<Tabs>
<Tab title="Log analysis">

You can use `percentiles_arrayif` to analyze request durations in HTTP logs while filtering for specific criteria, such as certain HTTP statuses or geographic locations.

**Query**

```kusto
['sample-http-logs']
| where geo.country == 'US'
| summarize DurationPercentiles=percentiles_arrayif(req_duration_ms, 50, 90, 95, 99, status == '200')
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B%27sample-http-logs%27%5D%20%7C%20where%20geo.country%20%3D%3D%20%27US%27%20%7C%20summarize%20DurationPercentiles%3Dpercentiles_arrayif%28req_duration_ms%2C%2050%2C%2090%2C%2095%2C%2099%2C%20status%20%3D%3D%20%27200%27%29%22%7D)

**Output**

| DurationPercentiles      |
|--------------------------|
| [103, 180, 210, 260]     |

This query filters records to those originating in the United States and with a status of ‘200’. It returns an array of approximate percentile values for the request durations.

</Tab>
<Tab title="OpenTelemetry traces">

Use `percentiles_arrayif` to track performance of spans and filter on a specific `kind` of service operation. This lets you quickly gauge how request durations differ for incoming traffic (for example, server spans).

**Query**

```kusto
['otel-demo-traces']
| where service.name == 'frontend'
| summarize SpanPercentiles=percentiles_arrayif(duration, 50, 90, 95, 99, kind == 'server')
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B%27otel-demo-traces%27%5D%20%7C%20where%20service.name%20%3D%3D%20%27frontend%27%20%7C%20summarize%20SpanPercentiles%3Dpercentiles_arrayif%28duration%2C%2050%2C%2090%2C%2095%2C%2099%2C%20kind%20%3D%3D%20%27server%27%29%22%7D)

**Output**

| SpanPercentiles           |
|---------------------------|
| [35ms, 80ms, 100ms, 115ms]|

This query returns an array of approximate percentile values for span durations in a ‘server’ context within the ‘frontend’ service.

</Tab>
<Tab title="Security logs">

You can focus on potentially unauthorized requests by filtering for specific status codes, then see how request durations are distributed in those scenarios.

**Query**

```kusto
['sample-http-logs']
| where status == '401'
| summarize DurationPercentiles=percentiles_arrayif(req_duration_ms, 50, 90, 95, 99, true)
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B%27sample-http-logs%27%5D%20%7C%20where%20status%20%3D%3D%20%27401%27%20%7C%20summarize%20DurationPercentiles%3Dpercentiles_arrayif%28req_duration_ms%2C%2050%2C%2090%2C%2095%2C%2099%2C%20true%29%22%7D)

**Output**

| DurationPercentiles      |
|--------------------------|
| [150, 280, 320, 400]     |

This query calculates percentile values for request durations that return a ‘401’ status code.

</Tab>
</Tabs>

## List of related functions

- [avg](/apl/array-functions/avg): Returns the average of a numeric column.
- [percentile](/apl/array-functions/percentile): Returns a single approximate percentile value.
- [percentile_if](/apl/aggregation-function/percentileif): 
- [percentiles_array](/apl/array-functions/percentiles_array): Returns an array of approximate percentile values for all rows without a predicate.
- [sum](/apl/array-functions/sum): Returns the sum of a numeric column.