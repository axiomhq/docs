---
title: 'genai_extract_tool_calls'
description: 'This page explains how to use the genai_extract_tool_calls function in APL.'
---

The `genai_extract_tool_calls` function extracts tool call requests from GenAI messages. When an AI model decides to use external tools or functions, it generates tool call messages. This function retrieves those calls so you can analyze what tools are being invoked.

You can use this function to monitor tool usage patterns, debug function calling, track API integrations, or analyze which tools are most frequently requested by your AI applications.

## For users of other query languages

If you come from other query languages, this section explains how to adjust your existing queries to achieve the same results in APL.

<AccordionGroup>
<Accordion title="Splunk SPL users">

In Splunk SPL, you would need to filter and extract tool call information from nested message structures manually.

<CodeGroup>
```sql Splunk example
| eval tool_calls=mvfilter(match(role, "assistant") AND isnotnull(tool_calls))
| eval tools=spath(tool_calls, "tool_calls")
```

```kusto APL equivalent
['ai-logs']
| extend tools = genai_extract_tool_calls(messages)
```
</CodeGroup>

</Accordion>
<Accordion title="ANSI SQL users">

In ANSI SQL, you would need to unnest arrays and extract JSON fields for tool calls.

<CodeGroup>
```sql SQL example
SELECT 
  conversation_id,
  JSON_EXTRACT(content, '$.tool_calls') as tool_calls
FROM conversations
CROSS JOIN UNNEST(messages)
WHERE JSON_EXTRACT(content, '$.tool_calls') IS NOT NULL
```

```kusto APL equivalent
['ai-logs']
| extend tool_calls = genai_extract_tool_calls(messages)
```
</CodeGroup>

</Accordion>
</AccordionGroup>

## Usage

### Syntax

```kusto
genai_extract_tool_calls(messages)
```

### Parameters

| Name | Type | Required | Description |
|------|------|----------|-------------|
| messages | dynamic | Yes | An array of message objects from a GenAI conversation. Each message typically contains `role` and `content` fields. |

### Returns

Returns a dynamic object containing the tool calls from the conversation, or null if no tool calls are found. Tool calls typically include function name, arguments, and call ID.

## Use case examples

<Tabs>
<Tab title="Log analysis">

Analyze which tools and functions are being called by your AI system to understand integration patterns.

**Query**

```kusto
['sample-http-logs']
| where uri contains '/api/chat'
| extend tools = genai_extract_tool_calls(todynamic(response_body)['messages'])
| where isnotnull(tools)
| extend tool_name = tostring(todynamic(tools)[0]['function']['name'])
| summarize call_count = count() by tool_name
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B'sample-http-logs'%5D%20%7C%20where%20uri%20contains%20'%2Fapi%2Fchat'%20%7C%20extend%20tools%20%3D%20genai_extract_tool_calls(todynamic(response_body)%5B'messages'%5D)%20%7C%20where%20isnotnull(tools)%20%7C%20extend%20tool_name%20%3D%20tostring(todynamic(tools)%5B0%5D%5B'function'%5D%5B'name'%5D)%20%7C%20summarize%20call_count%20%3D%20count()%20by%20tool_name%22%7D)

**Output**

| tool_name | call_count |
|-----------|------------|
| get_weather | 245 |
| search_database | 189 |
| send_email | 123 |

This query shows which tools are most frequently called, helping you understand integration usage patterns.

</Tab>
<Tab title="OpenTelemetry traces">

Monitor tool usage across services to understand which parts of your system rely on function calling.

**Query**

```kusto
['otel-demo-traces']
| where ['service.name'] == 'frontend' and kind == 'server'
| extend tool_calls = genai_extract_tool_calls(todynamic(attributes['ai.messages']))
| where isnotnull(tool_calls)
| project _time, trace_id, span_id, duration, tool_calls
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B'otel-demo-traces'%5D%20%7C%20where%20%5B'service.name'%5D%20%3D%3D%20'frontend'%20and%20kind%20%3D%3D%20'server'%20%7C%20extend%20tool_calls%20%3D%20genai_extract_tool_calls(todynamic(attributes%5B'ai.messages'%5D))%20%7C%20where%20isnotnull(tool_calls)%20%7C%20project%20_time%2C%20trace_id%2C%20span_id%2C%20duration%2C%20tool_calls%22%7D)

**Output**

| _time | trace_id | span_id | duration | tool_calls |
|-------|----------|---------|----------|------------|
| 2024-01-15T10:30:00Z | abc123 | span_001 | 2.3s | `[{"id": "call_1", "function": {"name": "get_weather", "arguments": "{\"location\": \"NYC\"}"}}]` |
| 2024-01-15T10:31:00Z | def456 | span_002 | 1.8s | `[{"id": "call_2", "function": {"name": "check_inventory", "arguments": "{\"product_id\": \"123\"}"}}]` |

This query correlates tool calls with trace duration, helping you understand the performance impact of function calling.

</Tab>
<Tab title="Security logs">

Monitor for suspicious tool calls that might indicate privilege escalation or unauthorized actions.

**Query**

```kusto
['sample-http-logs']
| where uri contains '/api/ai'
| extend tools = genai_extract_tool_calls(todynamic(response_body)['messages'])
| where isnotnull(tools)
| extend tool_str = tostring(tools)
| where tool_str contains 'delete' or tool_str contains 'admin' or tool_str contains 'execute'
| project _time, id, ['geo.country'], uri, tools
```

[Run in Playground](https://play.axiom.co/axiom-play-qf1k/query?initForm=%7B%22apl%22%3A%22%5B'sample-http-logs'%5D%20%7C%20where%20uri%20contains%20'%2Fapi%2Fai'%20%7C%20extend%20tools%20%3D%20genai_extract_tool_calls(todynamic(response_body)%5B'messages'%5D)%20%7C%20where%20isnotnull(tools)%20%7C%20extend%20tool_str%20%3D%20tostring(tools)%20%7C%20where%20tool_str%20contains%20'delete'%20or%20tool_str%20contains%20'admin'%20or%20tool_str%20contains%20'execute'%20%7C%20project%20_time%2C%20id%2C%20%5B'geo.country'%5D%2C%20uri%2C%20tools%22%7D)

**Output**

| _time | id | geo.country | uri | tools |
|-------|----|--------------|----|-------|
| 2024-01-15T10:30:00Z | user_789 | US | /api/ai/agent | `[{"function": {"name": "delete_user", "arguments": "{\"user_id\": \"admin\"}"}}]` |
| 2024-01-15T10:35:00Z | user_234 | CN | /api/ai/chat | `[{"function": {"name": "execute_command", "arguments": "{\"cmd\": \"rm -rf\"}"}}]` |

This query identifies potentially dangerous tool calls that might indicate security issues or malicious attempts.

</Tab>
</Tabs>

## List of related functions

- [genai_extract_function_results](/apl/scalar-functions/genai-functions/genai-extract-function-results): Extracts function call results. Use this to see the outcomes of the tool calls.
- [genai_has_tool_calls](/apl/scalar-functions/genai-functions/genai-has-tool-calls): Checks if messages contain tool calls. Use this to quickly filter conversations with function calling.
- [genai_extract_assistant_response](/apl/scalar-functions/genai-functions/genai-extract-assistant-response): Extracts assistant text responses. Use this when you need the text response instead of tool calls.
- [genai_get_content_by_role](/apl/scalar-functions/genai-functions/genai-get-content-by-role): Gets content by role. Use this for more granular extraction of specific message types.

